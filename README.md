# trend-similarity

## 柱形分布图的相似度分析



## 1. 输入数据格式

Excel 表格包含以下字段：

| 字段名    | 说明                                                  |
| --------- | ----------------------------------------------------- |
| Type      | `main` / `sub`                                        |
| match_id1 | 同一个对比组 ID                                       |
| match_id2 | 每条曲线的唯一 ID                                     |
| s6        | 柱状图对应的一维数值序列（如 `[0, 1, 40, -20, ...]`） |

## 2. 系统接口说明

数据处理

```python
load_match_groups(excel_path)
输出：
{
  match_id1: {
    "main": {
        "id": match_id2,
        "series": np.ndarray
    },
    "subs": [
        {
            "id": match_id2,
            "series": np.ndarray
        },
        ...
    ]
  },
  match_id2: {}
}
```

轮廓趋势

```
extract_signed_area_contour(series,window=3)		输出:contour
contour_to_trend_segments(contour)			
输出:
segments:[
      {"trend": "+", "start": 0, "end": 18, "value": 12.3},
      {"trend": "-", "start": 18, "end": 39, "value": -8.7},
      {"trend": "+", "start": 39, "end": 52, "value": 21.5},
    ]
segments_to_timeline(segments) 
输出一个数组
```



| 方法                 | 问题               |
| -------------------- | ------------------ |
| 趋势符号序列 (+ - 0) | 信息损失太大       |
| segment + IoU        | 边界极其敏感       |
| timeline 滑动        | 人工对齐规则过多   |
| 容忍 mIoU            | 还是在补丁式修规则 |
| **DTW(contour)**     | ✅ 自动处理一切     |



> ### 以 **a 组（a11 / a22）** 为例（b 、c组同理）
>
> 对每个 `match_id`，只看 **final_score ≥ threshold 的副数据**，设这些副数据为 `subs`，数量为 `k`。
>
> ### ✅ 规则 1：k == 1
>
> > 如果只有 1 个副数据
> >  👉 **直接根据这一条来选**
>
> - 如果 `sub.a11 > 0` → 选 `a11`
> - 如果 `sub.a22 > 0` → 选 `a22`
> - 如果都 ≤ 0 → 都不选
>
> ⚠️ 注意：
>  **a11 / a22 最多只可能有一个 >0**（你数据天然保证）
>
> ------
>
> ### ✅ 规则 2：k == 2
>
> > 如果有 2 个副数据
>
> - 如果 `sub1.a11` 与 `sub2.a11` **异号**
>   - （此时 a22 也一定异号）
>      👉 **a 组整体矛盾 → a11、a22 全不选**
> - 否则（同号）：
>   - 如果 `a11 > 0` → 选 a11
>   - 如果 `a22 > 0` → 选 a22
>   - 否则 → 不选
>
> ------
>
> ### ✅ 规则 3：k >= 3
>
> > 比如a组，看 **a11、a22哪一个> 0 的个数占多数选哪个**
>
> - `cnt_pos = a11 > 0 的个数`
> - `cnt_neg = a11 < 0 的个数`
> - 如果 `cnt_pos > cnt_neg` → 选 a11
> - 否则 → **a 组不选任何**
>
> ⚠️ 这里 **不会选 a22**（这是你规则里非常重要的一点）

## 约束关系

### ✅ a 组（a11 / a22）

a11与a22一般是异号的

- **最多选 1 个**
- 可能结果：
  - 只选 a11
  - 只选 a22
  - 两个都不选
- ❌ 不可能两个都选

### ✅ b 组（b11 / b22）

- 同 a 组规则

### ✅ c 组（c11 / c22 / c33）

- **最多选 1 个**

- 可能结果：

  - 只选其中一个

    

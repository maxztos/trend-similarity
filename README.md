# trend-similarity

## 直方图 / 柱形分布图的趋势相似度分析说明

> 本项目关注 **直方图序列的趋势相似性分析**，而非简单的数值距离或点对点对齐。
> 目标是：在每个 match 组内，从若干副数据中识别与主数据 **走势结构最相似** 的样本，并输出可用于后续业务规则计算的相似度评分。

------

## 1. 输入数据格式

原始数据存储于 Excel 表格中，包含如下字段：

| 字段名    | 说明                                                         |
| --------- | ------------------------------------------------------------ |
| Type      | 数据类型：`主数据` / `副数据`                                |
| match_id1 | 对比分组 ID（同一主数据及其候选副数据）                      |
| match_id2 | 唯一 ID                                                      |
| s6        | 一维数值序列（表示柱形分布 / 直方图），长度不固定，例如 `[0, 1, 40, -20, ...]` |
| a11-c33   | 业务数据                                                     |

### 数据结构约定

- 每个 `match_id1` 下：
  - **仅有 1 条主数据**
  - **包含若干条副数据**
- 序列长度在不同样本之间可能不同
- 数据存在噪声、小幅抖动，但整体趋势具有业务语义



## 2. 系统接口说明

数据处理

```python
load_match_groups(excel_path)
输出：
{
  match_id1: {
    "main": {
        "id": match_id2,
        "series": np.ndarray
    },
    "subs": [
        {
            "id": match_id2,
            "series": np.ndarray
        },
        ...
    ]
  },
  match_id2: {}
}
```

轮廓趋势

```
extract_signed_area_contour(series,window=3)		输出:contour

```

方案评估总结

| 方法                 | 问题               |
| -------------------- | ------------------ |
| 趋势符号序列 (+ - 0) | 信息损失太大       |
| segment + IoU        | 边界极其敏感       |
| timeline 滑动        | 人工对齐规则过多   |
| 容忍 mIoU            | 还是在补丁式修规则 |
| **DTW(contour)**     | ✅ 自动处理一切     |

> ⚠️ 结论：
>  单纯依赖 **规则工程或朴素距离函数**，容易出现“分数高但人眼不相似”的情况。

## 3. 相似度评分的业务用途说明

相似度评分 **不是最终结果**，而是后续业务规则计算的输入。

在每个 `match_id` 内：

- 只考虑 `final_score ≥ threshold` 的副数据
- 设这些副数据集合为 `subs`
- 数量记为 `k = |subs|`

## 4. A / B / C 组业务规则说明（用于评分后的决策）

### 4.1 A 组（a11 / a22）规则示例（B 组同理）

#### 先验业务约束

- `a11` 与 `a22` 通常为异号
- 单条副数据中：
  - 最多只有一个为正
- 最终结果中：
  - **最多选择 1 个**
  - 不允许同时选择 `a11` 和 `a22`

------

### 情况一：k == 1（仅 1 条相似副数据）

- 若 `sub.a11 > 0` → 选 `a11`
- 若 `sub.a22 > 0` → 选 `a22`
- 否则 → 不选

------

### 情况二：k >= 2（多条相似副数据，进行投票选择，哪列副数据正数个数多，选择该列的主数据的值）

采用多数投票机制：

- `cnt_pos = a11 > 0 的样本数`
- `cnt_neg = a11 < 0 的样本数`

判定规则：

- 若 `cnt_pos > cnt_neg` → 选 `a11`
- 否则 → 选a22

------

### 4.2 B 组（b11 / b22）

- 规则与 A 组完全一致

------

### 4.3 C 组（c11 / c22 / c33）

- 候选维度为 3 个
- 最多选择 1 个
- 不允许多选
- 具体实现上遵循与 A / B 组一致的思想，仅在候选数量上扩展

------

例如：



## 5. 重要说明

- 本项目的核心难点 **不在规则本身**，而在：
  - 如何定义“趋势相似”
  - 如何让相似度评分与人类直观判断一致
- 相似性判断结果将直接影响业务指标统计的稳定性与可信度。
